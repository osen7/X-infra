# Unix Domain Socket (UDS) IPC è¿ç§»å®ŒæˆæŠ¥å‘Š

## âœ… å®ŒæˆçŠ¶æ€

**æ”»åšæˆ˜ 2ï¼šç”Ÿäº§çº§ IPC æ”¹é€ ** - **å·²å®Œæˆ**

## ğŸ¯ æ”¹é€ ç›®æ ‡

å°† IPC é€šä¿¡ä» TCP Socket (`127.0.0.1:9090`) è¿ç§»åˆ° Unix Domain Socketï¼Œå®ç°ï¼š
1. âœ… å½»åº•è§£å†³ç«¯å£å†²çªé—®é¢˜
2. âœ… åˆ©ç”¨ Linux æ–‡ä»¶ç³»ç»Ÿæƒé™æ§åˆ¶
3. âœ… ç¬¦åˆ Linux Daemon æœ€ä½³å®è·µ
4. âœ… ä¿æŒ Windows å¹³å°å…¼å®¹æ€§ï¼ˆå›é€€åˆ° TCPï¼‰

## ğŸ“‹ å®ç°ç»†èŠ‚

### 1. IPC æœåŠ¡å™¨æ”¹é€  (`agent/src/ipc.rs`)

#### Unix å¹³å°
- ä½¿ç”¨ `tokio::net::UnixListener` å’Œ `UnixStream`
- Socket è·¯å¾„ä¼˜å…ˆçº§ï¼š
  1. `/var/run/ark.sock`ï¼ˆç³»ç»Ÿçº§ï¼Œéœ€è¦ root æƒé™ï¼‰
  2. `~/.ark/ark.sock`ï¼ˆç”¨æˆ·çº§ï¼Œè‡ªåŠ¨å›é€€ï¼‰
- Socket æ–‡ä»¶æƒé™ï¼š`chmod 660`ï¼ˆrw-rw----ï¼‰
- è‡ªåŠ¨æ¸…ç†ï¼šdaemon é€€å‡ºæ—¶åˆ é™¤ Socket æ–‡ä»¶

#### Windows å¹³å°
- ä¿æŒä½¿ç”¨ `TcpListener` å’Œ `TcpStream`
- é»˜è®¤ç«¯å£ï¼š9090
- å®Œå…¨å‘åå…¼å®¹

### 2. IPC å®¢æˆ·ç«¯æ”¹é€  (`agent/src/ipc.rs`)

- Unixï¼š`IpcClient::new(Option<PathBuf>)` - å¯é€‰ Socket è·¯å¾„
- Windowsï¼š`IpcClient::new(u16)` - ç«¯å£å·
- è‡ªåŠ¨ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼ˆUnixï¼‰æˆ–é»˜è®¤ç«¯å£ï¼ˆWindowsï¼‰

### 3. CLI å‚æ•°æ›´æ–° (`agent/src/main.rs`)

#### Unix å¹³å°
```bash
# ä½¿ç”¨é»˜è®¤ Socket è·¯å¾„
ark run
ark ps
ark why <pid>
ark diag <pid>

# æŒ‡å®šè‡ªå®šä¹‰ Socket è·¯å¾„
ark run --socket-path /tmp/ark.sock
ark ps --socket-path /tmp/ark.sock
```

#### Windows å¹³å°
```bash
# ä½¿ç”¨é»˜è®¤ç«¯å£
ark run
ark ps
ark why <pid> --port 9090
ark diag <pid> --port 9090
```

### 4. æƒé™æ§åˆ¶

#### Socket æ–‡ä»¶æƒé™
- **æ¨¡å¼**ï¼š`0o660` (rw-rw----)
- **Owner**ï¼šåˆ›å»º daemon çš„ç”¨æˆ·
- **Group**ï¼šdaemon ç”¨æˆ·çš„ç»„
- **Others**ï¼šæ— æƒé™

#### ä½¿ç”¨åœºæ™¯
```bash
# åœºæ™¯ 1ï¼šç³»ç»Ÿçº§éƒ¨ç½²ï¼ˆéœ€è¦ rootï¼‰
sudo ark run
# Socket: /var/run/ark.sock (root:root, 660)
# åªæœ‰ root å’Œ wheel ç»„å¯ä»¥è®¿é—®

# åœºæ™¯ 2ï¼šç”¨æˆ·çº§éƒ¨ç½²
ark run
# Socket: ~/.ark/ark.sock (user:user, 660)
# åªæœ‰è¯¥ç”¨æˆ·å’ŒåŒç»„ç”¨æˆ·å¯ä»¥è®¿é—®
```

### 5. é”™è¯¯å¤„ç†

- âœ… Socket æ–‡ä»¶å·²å­˜åœ¨æ—¶è‡ªåŠ¨åˆ é™¤ï¼ˆå¤„ç†å¼‚å¸¸é€€å‡ºï¼‰
- âœ… çˆ¶ç›®å½•ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»º
- âœ… æƒé™è®¾ç½®å¤±è´¥æ—¶ç»™å‡ºè­¦å‘Šä½†ä¸é˜»å¡
- âœ… è¿æ¥å¤±è´¥æ—¶æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

## ğŸ”§ æŠ€æœ¯å®ç°

### æ¡ä»¶ç¼–è¯‘

ä½¿ç”¨ Rust çš„æ¡ä»¶ç¼–è¯‘ç‰¹æ€§å®ç°è·¨å¹³å°å…¼å®¹ï¼š

```rust
#[cfg(unix)]
use tokio::net::{UnixListener, UnixStream};

#[cfg(windows)]
use tokio::net::{TcpListener, TcpStream};
```

### é»˜è®¤è·¯å¾„é€‰æ‹©

```rust
#[cfg(unix)]
pub fn default_socket_path() -> PathBuf {
    let system_path = PathBuf::from("/var/run/ark.sock");
    if std::fs::metadata("/var/run").is_ok() {
        system_path
    } else {
        // å›é€€åˆ°ç”¨æˆ·ç›®å½•
        let mut home = std::env::var("HOME")
            .map(PathBuf::from)
            .unwrap_or_else(|_| PathBuf::from("."));
        home.push(".ark");
        home.push("ark.sock");
        home
    }
}
```

## ğŸ“Š å¯¹æ¯”ï¼šTCP vs UDS

| ç‰¹æ€§ | TCP Socket | Unix Domain Socket |
|------|------------|-------------------|
| ç«¯å£å†²çª | âŒ å¯èƒ½å†²çª | âœ… æ— ç«¯å£æ¦‚å¿µ |
| æƒé™æ§åˆ¶ | âŒ éœ€è¦é˜²ç«å¢™ | âœ… æ–‡ä»¶ç³»ç»Ÿæƒé™ |
| æ€§èƒ½ | è¾ƒæ…¢ï¼ˆç½‘ç»œæ ˆï¼‰ | âœ… æ›´å¿«ï¼ˆå†…æ ¸ç›´æ¥æ‹·è´ï¼‰ |
| å®‰å…¨æ€§ | ä¸­ç­‰ | âœ… æ›´é«˜ï¼ˆæœ¬åœ°é€šä¿¡ï¼‰ |
| è·¨å¹³å° | âœ… å…¨å¹³å° | âš ï¸ ä»… Unix-like |

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨ Daemon

```bash
# Unix (è‡ªåŠ¨é€‰æ‹©è·¯å¾„)
$ ark run
[ark] å¯åŠ¨äº‹ä»¶æ€»çº¿...
[ark] IPC æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬ Unix Socket: /var/run/ark.sock
[ark] æŒ‰ Ctrl+C é€€å‡º

# æˆ–æŒ‡å®šè‡ªå®šä¹‰è·¯å¾„
$ ark run --socket-path /tmp/ark.sock
[ark] IPC æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬ Unix Socket: /tmp/ark.sock
```

### æŸ¥è¯¢è¿›ç¨‹

```bash
$ ark ps
PID      | JOB_ID       | RESOURCES           | STATE
----------------------------------------------------------------
12345    | job-001      | gpu-0, gpu-1        | running
```

### è¯Šæ–­è¿›ç¨‹

```bash
$ ark diag 12345
[ark] æ­£åœ¨è¯Šæ–­è¿›ç¨‹ 12345...
[AI è¯Šæ–­æŠ¥å‘Š]
...
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **æ–‡ä»¶æƒé™**ï¼šSocket æ–‡ä»¶è®¾ç½®ä¸º 660ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®
2. **è·¯å¾„é€‰æ‹©**ï¼šä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿè·¯å¾„ï¼ˆéœ€è¦ rootï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ç”¨æˆ·ç›®å½•
3. **è‡ªåŠ¨æ¸…ç†**ï¼šdaemon é€€å‡ºæ—¶åˆ é™¤ Socket æ–‡ä»¶ï¼Œé˜²æ­¢æƒé™æ³„éœ²
4. **å¤§å°é™åˆ¶**ï¼šä¿æŒ 10MB è¯·æ±‚é™åˆ¶å’Œ 100MB å“åº”é™åˆ¶

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **systemd é›†æˆ**ï¼šåˆ›å»º systemd service æ–‡ä»¶ï¼Œè‡ªåŠ¨ç®¡ç† Socket æ–‡ä»¶
2. **æƒé™ç»„ç®¡ç†**ï¼šæ”¯æŒé…ç½®å…è®¸è®¿é—®çš„ç»„ï¼ˆå¦‚ `docker`ã€`wheel`ï¼‰
3. **Socket æ¿€æ´»**ï¼šä½¿ç”¨ systemd socket activationï¼ˆé«˜çº§ç‰¹æ€§ï¼‰
4. **ç›‘æ§å’Œæ—¥å¿—**ï¼šæ·»åŠ  Socket è¿æ¥ç›‘æ§å’Œæ—¥å¿—è®°å½•

## âœ… æµ‹è¯•æ¸…å•

- [x] Unix å¹³å°ï¼šé»˜è®¤è·¯å¾„åˆ›å»ºå’Œè¿æ¥
- [x] Unix å¹³å°ï¼šè‡ªå®šä¹‰è·¯å¾„åˆ›å»ºå’Œè¿æ¥
- [x] Unix å¹³å°ï¼šæƒé™è®¾ç½®ï¼ˆchmod 660ï¼‰
- [x] Unix å¹³å°ï¼šSocket æ–‡ä»¶æ¸…ç†
- [x] Windows å¹³å°ï¼šTCP Socket å‘åå…¼å®¹
- [x] è·¨å¹³å°ï¼šæ¡ä»¶ç¼–è¯‘æ­£ç¡®æ€§

## ğŸ‰ æ€»ç»“

**Unix Domain Socket IPC æ”¹é€ å·²å®Œæˆï¼**

- âœ… å®Œå…¨ç¬¦åˆ Linux Daemon æœ€ä½³å®è·µ
- âœ… åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿæƒé™å®ç°ç»†ç²’åº¦è®¿é—®æ§åˆ¶
- âœ… å½»åº•è§£å†³ç«¯å£å†²çªé—®é¢˜
- âœ… ä¿æŒ Windows å¹³å°å®Œå…¨å…¼å®¹
- âœ… æ€§èƒ½æå‡ï¼ˆå†…æ ¸ç›´æ¥æ‹·è´ï¼Œæ— ç½‘ç»œæ ˆå¼€é”€ï¼‰

**ä¸‹ä¸€æ­¥**ï¼šå¯ä»¥å¼€å§‹å®ç° eBPF ç½‘ç»œæ¢é’ˆï¼ˆæ”»åšæˆ˜ 1ï¼‰æˆ–é—­ç¯æ‰§è¡Œå™¨ï¼ˆæ‰«å°¾æˆ˜ 3ï¼‰ã€‚
