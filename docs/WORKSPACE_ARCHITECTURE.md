# xctl Workspace æ¶æ„

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
x-infra/
â”œâ”€â”€ Cargo.toml              # Workspace æ ¹é…ç½®
â”‚
â”œâ”€â”€ core/                   # å…±äº«åº•åº§ï¼ˆxctl-coreï¼‰
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ lib.rs          # é‡æ–°å¯¼å‡ºå¸¸ç”¨ç±»å‹
â”‚       â”œâ”€â”€ event.rs        # äº‹ä»¶ç³»ç»Ÿï¼ˆEvent, EventType, EventBusï¼‰
â”‚       â”œâ”€â”€ graph.rs        # çŠ¶æ€å›¾å¼•æ“ï¼ˆStateGraph, Edge, Nodeï¼‰
â”‚       â””â”€â”€ rules/          # è§„åˆ™å¼•æ“ï¼ˆRuleEngine, Rule, Matcherï¼‰
â”‚
â”œâ”€â”€ agent/                  # å•æœºèŠ‚ç‚¹ç¨‹åºï¼ˆxctlï¼‰
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.rs         # CLI å…¥å£ï¼ˆrun, ps, why, zap, diag, fixï¼‰
â”‚       â”œâ”€â”€ plugin/         # æ¢é’ˆæ’ä»¶ç³»ç»Ÿ
â”‚       â”œâ”€â”€ exec/           # æ‰§è¡Œå¼•æ“ï¼ˆFixEngine, ActionExecutorï¼‰
â”‚       â”œâ”€â”€ ipc.rs          # IPC é€šä¿¡ï¼ˆUnix Domain Socket / TCPï¼‰
â”‚       â”œâ”€â”€ diag.rs         # AI è¯Šæ–­
â”‚       â””â”€â”€ scene/          # åœºæ™¯åˆ†æå™¨
â”‚
â””â”€â”€ hub/                    # å…¨å±€ä¸­æ§ï¼ˆxctl-hubï¼‰
    â”œâ”€â”€ Cargo.toml
    â””â”€â”€ src/
        â””â”€â”€ main.rs         # Hub æœåŠ¡å™¨ï¼ˆWebSocketï¼Œå…¨å±€å›¾ï¼‰
```

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å…±äº«åº•åº§ï¼ˆCoreï¼‰

**èŒè´£**ï¼š
- å®šä¹‰äº‹ä»¶ç³»ç»Ÿï¼ˆEvent, EventTypeï¼‰
- å®ç°çŠ¶æ€å›¾å¼•æ“ï¼ˆStateGraphï¼‰
- å®ç°è§„åˆ™å¼•æ“ï¼ˆRuleEngineï¼‰

**ç‰¹ç‚¹**ï¼š
- æ— å¹³å°ä¾èµ–ï¼ˆçº¯ Rustï¼‰
- æ— å¤–éƒ¨ä¾èµ–ï¼ˆä»…æ ‡å‡†åº“å’Œ tokioï¼‰
- å¯è¢« agent å’Œ hub å…±åŒä½¿ç”¨

### 2. å•æœºèŠ‚ç‚¹ï¼ˆAgentï¼‰

**èŒè´£**ï¼š
- è¿è¡Œæ¢é’ˆï¼ˆeBPF, NVML, è‡ªå®šä¹‰è„šæœ¬ï¼‰
- ç»´æŠ¤æœ¬åœ°çŠ¶æ€å›¾
- æä¾› CLI æ¥å£ï¼ˆrun, ps, why, zap, diag, fixï¼‰
- é€šè¿‡ IPC æä¾›æœåŠ¡

**ç‰¹ç‚¹**ï¼š
- ä¾èµ– core å…±äº«åº•åº§
- å¹³å°ç‰¹å®šä»£ç ï¼ˆUnix/Windows IPCï¼‰
- å¯é€‰çš„ Hub è¿æ¥ï¼ˆè¾¹ç¼˜ä¸ŠæŠ¥ï¼‰

### 3. å…¨å±€ä¸­æ§ï¼ˆHubï¼‰

**èŒè´£**ï¼š
- æ¥æ”¶å„èŠ‚ç‚¹çš„ WebSocket è¿æ¥
- ç»´æŠ¤å…¨å±€çŠ¶æ€å›¾ï¼ˆGlobalGraphï¼‰
- æä¾›è·¨èŠ‚ç‚¹æŸ¥è¯¢æ¥å£
- æ‰§è¡Œé›†ç¾¤çº§ä¿®å¤æ“ä½œ

**ç‰¹ç‚¹**ï¼š
- ä¾èµ– core å…±äº«åº•åº§
- æ— çŠ¶æ€è®¾è®¡ï¼ˆå†…å­˜å›¾ï¼‰
- è½»é‡çº§ï¼ˆæ— å¤–éƒ¨æ•°æ®åº“ï¼‰

## ğŸ”— ä¾èµ–å…³ç³»

```
hub â”€â”€â”
      â”œâ”€â”€> core (å…±äº«åº•åº§)
agent â”€â”˜
```

- **hub** å’Œ **agent** éƒ½ä¾èµ– **core**
- **hub** å’Œ **agent** ä¹‹é—´æ— ç›´æ¥ä¾èµ–
- é€šè¿‡ WebSocket åè®®é€šä¿¡

## ğŸ“¡ é€šä¿¡åè®®

### Agent â†’ Hub

**WebSocket æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
  "node_id": "node-01",
  "event": {
    "ts": 1234567890,
    "event_type": "transport.drop",
    "entity_id": "network-eth0",
    "pid": 12345,
    "value": "1"
  }
}
```

### Hub â†’ Agent

**å‘½ä»¤æ ¼å¼**ï¼š
```json
{
  "command": "fix",
  "target": "job-llm-train-99",
  "actions": ["signal", "kill"]
}
```

## ğŸš€ ä¸‹ä¸€æ­¥

1. **Hub WebSocket æœåŠ¡å™¨**
   - å®ç°äº‹ä»¶æ¥æ”¶
   - ç»´æŠ¤å…¨å±€å›¾
   - æä¾›æŸ¥è¯¢æ¥å£

2. **Agent è¾¹ç¼˜ä¸ŠæŠ¥**
   - æ·»åŠ  `--hub` å‚æ•°
   - å®ç°äº‹ä»¶è¿‡æ»¤
   - å®ç° WebSocket å®¢æˆ·ç«¯

3. **é›†ç¾¤çº§å‘½ä»¤**
   - `xctl cluster why <job-id>`
   - `xctl cluster fix <job-id>`
